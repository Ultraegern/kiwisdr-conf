<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KiwiSDR Recorder</title>
    <style>
        /* User-provided CSS */
        .fake-class { /* Apparently the first item isn't applied */
          margin-top: 20px;
          margin-bottom: 20px;
        }
        :root { /* Dark theme colors */
          --main-color-dark: #1e1e1e;
          --main-color-medium: #2a2a2a;
          --main-color-light: #555555;
          --accent-color: #ff5555;
          --accent-color-shadow: rgba(255, 85, 85, 0.5);
          --text-color-bright: #fafafa;
          --text-color-muted: #efefef;
          --main-color-medium-hover: #2f2f2f;
          --main-shadow-background: 0 6px 18px rgba(16, 24, 40, 0.3);
          --main-shadow-dark: 0 6px 18px rgba(16, 24, 40, 0.3);
          --main-shadow-dark-small: 0 1px 3px rgba(16, 24, 40, 0.3);
        }
        body {
          font-family: sans-serif;
          font-size: 1.2em;
          text-align: center;
          padding: 5%;
          background-color: var(--main-color-dark);
          color: var(--text-color-muted);
          /* Use min-height to ensure background covers viewport */
          min-height: 100vh; 
          margin: 0;
          padding-top: 2rem;
          padding-bottom: 2rem;
        }
        h1 {
          margin-top: 0px;
          margin-bottom: 20px;
          font-size: 3em;
          color: var(--accent-color);
        }
        h2 {
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: var(--text-color-bright);
        }
        p {
          margin-bottom: 5px;
        }
        span {
          margin-bottom: 10px;
        }
        button {
          margin-left: 15px;
          margin-bottom: 10px;
          margin-top: 10px;
          font-size: 1.0em;
          padding: 0.6em 1.2em;
          border-radius: 8px;
          cursor: pointer;
          transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
          border: 2px solid var(--main-color-light);
          background-color: var(--main-color-medium);
          color: var(--text-color-bright);
        }
        button:hover {
          border-color: var(--accent-color);
          background-color: var(--main-color-medium-hover);
        }
        button:focus {
          outline: none;
          border-color: var(--accent-color);
          box-shadow: 0 0 8px var(--accent-color-shadow);
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
          }
        .center {
          display: flex;
          justify-content: center;
          align-items: center;
          flex-direction: column;
        }
        .field {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 4px 8px;
          width: 350px;
          gap: 1rem; /* Added gap for spacing */
        }
        .field label {
            white-space: nowrap; /* Prevent labels from wrapping */
        }
        .field-group {
          display: flex;
          flex-direction: column;
          align-items: center;
          margin-bottom: 15px;
          /* Added background and padding to group the form */
          background-color: var(--main-color-medium);
          padding: 1.5rem;
          border-radius: 12px;
          box-shadow: var(--main-shadow-dark-small);
          max-width: 400px;
          margin-left: auto;
          margin-right: auto;
        }
        .field input[type="number"] {
          margin-bottom: 5px;
          padding: 0.5em 0.8em;
          font-size: 1.1em;
          border: 2px solid var(--main-color-light);
          border-radius: 8px;
          background-color: var(--main-color-medium);
          color: var(--text-color-bright);
          width: 100px; /* Adjusted width */
          text-align: center;
          transition: border-color 0.2s, box-shadow 0.2s;
          -moz-appearance: textfield; /* Remove spinners in Firefox */
        }
        .field input[type="number"]::-webkit-inner-spin-button, /* Remove spinners in Chrome, Safari, Edge */
        .field input[type="number"]::-webkit-outer-spin-button { /* Remove spinners in Chrome, Safari, Edge */
          -webkit-appearance: none;
          margin: 0;
        }
        .field input[type="number"]:hover {
          border-color: var(--accent-color);
        }
        .field input[type="number"]:focus {
          outline: none;
          border-color: var(--accent-color);
          box-shadow: 0 0 8px var(--accent-color-shadow);
        }
        .background {
          position:fixed;
          top:0;
          left:0;
          right:0;
          bottom:0;
          z-index:-1;
          
          background: linear-gradient(45deg, #5f1828, #4b2c3b, #1a3a4b, #1e4b3d);
          background-size: 150% 150%;
          /* Add animation for the background */
          animation: gradientBG 20s ease infinite;
        }
        /* Gradient animation */
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .grid{
          display:grid;
          grid-template-columns: repeat(3, 1fr);
          gap:32px;
          max-width:1000px;
        }
        .card{
          display:block;
          text-decoration:none;
          color:inherit;
          border-radius: 12px;
          overflow:hidden;
          transform-origin:center;
          transition:transform .28s cubic-bezier(.2,.9,.3,1), box-shadow .28s ease;
          box-shadow:var(--main-shadow-dark-small);
          background:var(--main-color-medium);
          width:100%;
        }
        .card-media{
          height:180px;
          background-size:cover;
          background-position:center;
          position:relative;
          display:block;
        }
        .card-media::after{
          content:"";
          position:absolute;
          inset:0;
          background:linear-gradient(180deg, rgba(0,0,0,0.08) 0%, rgba(0,0,0,0.2) 60%);
          pointer-events:none;
        }
        .card-title{
          padding:18px 18px 12px 18px;
          font-weight:700;
          font-size:1.2rem;
          line-height:1.2;
          color:var(--text-color-bright);
        }
        .card-body{
          padding:0 18px 18px 18px;
          color:var(--text-color-muted);
          font-size:0.95rem;
          line-height:1.45;
        }
        .card:hover,
        .card:focus{
          transform: translateY(-8px) scale(1.01);
          box-shadow:var(--main-shadow-dark); /* Corrected shadow variable */
          outline:3px solid var(--accent-color);
        }
        .table-container {
          display: flex;
          justify-content: center;
          margin-top: 2rem;
          /* Allow horizontal scroll on small screens */
          overflow-x: auto; 
          width: 100%;
          max-width: 1200px; /* Increased max-width */
          margin-left: auto;
          margin-right: auto;
        }
        table {
          border-collapse: collapse;
          width: 100%; /* Make table take full width of container */
          min-width: 1000px; /* Min-width to prevent squishing */
          background-color: var(--main-color-medium);
          color: var(--text-color-bright);
          box-shadow: var(--main-shadow-dark-small);
          border-radius: 8px;
          overflow: hidden;
        }
        th, td {
          padding: 12px 16px;
          text-align: left;
          border-bottom: 1px solid var(--main-color-light);
          white-space: nowrap; /* Prevent text wrapping */
        }
        table tr:last-child td {
          border-bottom: none;
        }
        th {
          background-color: var(--main-color-dark);
          font-weight: 600;
        }
        tr:hover {
          background-color: var(--main-color-medium-hover);
        }
        /* Small button for table actions */
        td button {
          margin: 0 4px; /* Added horizontal margin */
          font-size: 0.9em;
          padding: 0.4em 0.8em;
        }
        .field select {
          padding: 0.5em 0.8em;
          font-size: 1.1em;
          border: 2px solid var(--main-color-light);
          border-radius: 8px;
          background-color: var(--main-color-medium);
          color: var(--text-color-bright);
          transition: border-color 0.2s, box-shadow 0.2s;
          width: 118px; /* Matched input width + padding */
        }
        .field select:hover {
          border-color: var(--accent-color);
        }
        .field select:focus {
          outline: none;
          border-color: var(--accent-color);
          box-shadow: 0 0 8px var(--accent-color-shadow);
        }
        :disabled {
          opacity: 0.6;
        }
        input:disabled {
          cursor: not-allowed;
        }
        .button-group {
          display: flex;
          gap: 8px;
          justify-content: flex-end; /* Aligns buttons to the right */
          flex-wrap: wrap; /* Allow buttons to wrap on small screens */
        }
        @media (prefers-color-scheme: light) { /* Light theme (if system prefers light) */
          .background {
            background: linear-gradient(-45deg, #efa0ae, #d7b0be, #a0d1e5, #b0e5b7);
            animation-name: none; /* Disable animation for light mode */
          }
          :root {
            --main-color-dark: #aaaaaa;
            --main-color-medium: #cccccc;
            --main-color-light: #ffffff;
            --accent-color: #ff0000;
            --accent-color-shadow: rgba(255, 0, 0, 0.3);
            --text-color-bright: #1e1e1e;
            --text-color-muted: #2e2e2e;
            --main-color-medium-hover: #eeeeee;
          }
          button {
            border: 2px solid var(--main-color-dark);
            background-color: var(--main-color-light);
          }
          button:hover {
            background-color: var(--main-color-medium-hover);
          }
          .field input[type="number"] {
            border: 2px solid var(--main-color-dark);
            background-color: var(--main-color-light);
          }
          .field input[type="number"]:hover {
            background-color: var(--main-color-medium-hover);
          }
          .field select {
            border: 2px solid var(--main-color-dark);
            background-color: var(--main-color-light);
          }
          .field select:hover {
            background-color: var(--main-color-medium-hover);
          }
          .field select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 8px var(--accent-color-shadow);
          }
          table {
            background-color: var(--main-color-light);
            color: var(--text-color-bright);
          }
          th{
            background-color: var(--main-color-medium)
          }
          th, td {
            border-bottom: 1px solid var(--main-color-dark);
          }
          .field-group {
            background-color: var(--main-color-light);
          }
        }
        @media (max-width:960px) {
          .grid{ grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
          body { padding-left: 1rem; padding-right: 1rem; }
        }
        @media (max-width: 480px) {
            .field {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
                gap: 0.2rem;
            }
            .field input, .field select {
                width: 100%;
                box-sizing: border-box; /* Include padding in width */
            }
            .field-group {
                padding: 1rem;
                width: 90%;
            }
            h1 { font-size: 2.5em; }
            td button {
                display: block;
                width: 100px;
                margin: 4px auto;
            }
            .button-group {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Modal styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
        }
        .modal-content {
            background-color: var(--main-color-medium);
            margin: 10% auto; 
            padding: 20px;
            border: 1px solid var(--main-color-light);
            border-radius: 8px;
            width: 80%; 
            max-width: 700px;
            color: var(--text-color-bright);
            box-shadow: var(--main-shadow-dark);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--main-color-light);
            padding-bottom: 10px;
        }
        .modal-header h2 {
            margin: 0;
            color: var(--accent-color);
        }
        .modal-close {
            color: var(--text-color-muted);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: var(--text-color-bright);
            text-decoration: none;
            outline: none;
        }
        .modal-body {
            padding-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            background-color: var(--main-color-dark);
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            line-height: 1.5;
            white-space: pre-wrap; /* Wrap log lines */
        }
        #api-status {
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 6px;
        }
        #api-status.online {
            background-color: #28a745;
            color: white;
        }
        #api-status.offline {
            background-color: var(--accent-color);
            color: white;
        }
        #freq-range {
            font-size: 0.9em;
            margin-top: 10px;
            color: var(--text-color-muted);
        }
    </style>
</head>
<body>

    <div class="background"></div>

    <main class="center">
        <h1>KiwiSDR Recorder</h1>
        <span id="api-status">Checking API...</span>

        <form id="create-job-form">
            <div class="field-group">
                <h2>Create New Job</h2>
                <div class="field">
                    <label for="rec_type">Record Type:</label>
                    <select id="rec_type" name="rec_type">
                        <option value="png">PNG (Waterfall)</option>
                        <option value="iq">IQ (Raw Data)</option>
                    </select>
                </div>
                <div class="field">
                    <label for="frequency">Frequency (Hz):</label>
                    <input type="number" id="frequency" name="frequency" value="14204000" required>
                </div>
                <div class="field">
                    <label for="zoom">Zoom (0-14):</label>
                    <input type="number" id="zoom" name="zoom" value="10" min="0" max="14" required>
                </div>
                <div class="field">
                    <label for="duration">Duration (s):</label>
                    <input type="number" id="duration" name="duration" value="60" min="0" required>
                </div>
                <div class="field">
                    <label for="interval">Interval (s):</label>
                    <input type="number" id="interval" name="interval" placeholder="Optional (e.g., 3600)">
                </div>
                <div id="freq-range">
                    Range: 14.197 MHz - 14.211 MHz (BW: 14.65 kHz)
                </div>
                <button type="submit" id="create-job-btn">Start Job</button>
            </div>
        </form>

        <h2>Active Jobs</h2>
        <button id="refresh-btn">Refresh Now</button>
        <div class="table-container">
            <table id="jobs-table">
                <thead>
                    <tr>
                        <th>Job ID</th>
                        <th>Status</th>
                        <th>Type</th>
                        <th>Frequency (MHz)</th>
                        <th>Zoom</th>
                        <th>Duration (s)</th>
                        <th>Interval (s)</th>
                        <th>Started</th>
                        <th>Next Run</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="jobs-table-body">
                    <!-- Jobs will be populated here by JS -->
                </tbody>
            </table>
        </div>

    </main>

    <!-- Log Modal -->
    <div id="log-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="log-modal-title">Job Logs</h2>
                <span class="modal-close">&times;</span>
            </div>
            <div id="log-modal-body" class="modal-body">
                <!-- Logs will be populated here -->
            </div>
        </div>
    </div>

    <script type="module">
        // --- Type Definitions (as JSDoc comments) ---
        /**
         * @typedef {Object} RecorderSettings
         * @property {"png" | "iq"} rec_type
         * @property {number} frequency
         * @property {number} [zoom]
         * @property {number} duration
         * @property {number | null} [interval]
         */

        /**
         * @typedef {Object} Log
         * @property {number} timestamp
         * @property {string} data
         */

        /**
         * @typedef {Object} JobStatus
         * @property {number} job_id
         * @property {boolean} running
         * @property {number | null} started_at
         * @property {number | null} next_run_start
         * @property {Log[]} logs
         * @property {RecorderSettings} settings
         */

        // --- Constants ---
        const API_BASE_URL = 'https://kiwisdr.local/api'; // Use a relative path, assuming UI is served from the same domain as the API
        const MIN_FREQ = 0;
        const MAX_FREQ = 30_000_000;
        const REFRESH_INTERVAL_MS = 5000;

        // --- DOM Elements ---
        const apiStatusEl = document.getElementById('api-status');
        const createJobForm = document.getElementById('create-job-form');
        const createJobBtn = document.getElementById('create-job-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const jobsTableBody = document.getElementById('jobs-table-body');
        
        // Form inputs
        const recTypeInput = document.getElementById('rec_type');
        const frequencyInput = document.getElementById('frequency');
        const zoomInput = document.getElementById('zoom');
        const durationInput = document.getElementById('duration');
        const intervalInput = document.getElementById('interval');
        const freqRangeEl = document.getElementById('freq-range');

        // Modal elements
        const logModal = document.getElementById('log-modal');
        const logModalTitle = document.getElementById('log-modal-title');
        const logModalBody = document.getElementById('log-modal-body');
        const modalCloseBtn = logModal.querySelector('.modal-close');

        // --- State ---
        /** @type {Map<number, JobStatus>} */
        const jobsState = new Map();

        // --- Utility Functions ---

        /**
         * Formats a Unix timestamp (seconds) into a readable local time string
         * @param {number | null} unixTimestamp - Timestamp in seconds
         * @returns {string}
         */
        function formatTimestamp(unixTimestamp) {
            if (unixTimestamp === null || unixTimestamp === undefined) {
                return 'N/A';
            }
            // API uses seconds, Date constructor uses milliseconds
            return new Date(unixTimestamp * 1000).toLocaleString();
        }
        
        /**
         * Formats a frequency in Hz to MHz
         * @param {number} hz
         * @returns {string}
         */
        function formatFreqMHz(hz) {
            return (hz / 1_000_000).toFixed(3);
        }

        /**
         * Calculates bandwidth for a given zoom level
         * @param {number} zoom
         * @returns {number}
         */
        function calculateBandwidth(zoom) {
            return (MAX_FREQ - MIN_FREQ) / Math.pow(2, zoom);
        }

        /**
         * Updates the frequency range display in the form
         */
        function updateFreqRangeDisplay() {
            try {
                const center_freq = parseInt(frequencyInput.value, 10);
                const zoom = parseInt(zoomInput.value, 10);

                if (isNaN(center_freq) || isNaN(zoom)) {
                    freqRangeEl.textContent = 'Invalid input';
                    return;
                }
                
                const bandwidth = calculateBandwidth(zoom);
                const selection_freq_max = center_freq + (bandwidth / 2);
                const selection_freq_min = center_freq - (bandwidth / 2);
                
                const bwText = bandwidth > 1000 
                    ? `${(bandwidth / 1000).toFixed(2)} kHz` 
                    : `${bandwidth.toFixed(2)} Hz`;

                freqRangeEl.textContent = `Range: ${formatFreqMHz(selection_freq_min)} MHz - ${formatFreqMHz(selection_freq_max)} MHz (BW: ${bwText})`;
                
                // Validation
                if (selection_freq_min < MIN_FREQ || selection_freq_max > MAX_FREQ) {
                    freqRangeEl.style.color = 'var(--accent-color)';
                    freqRangeEl.textContent += ' - WARNING: Exceeds 0-30 MHz range!';
                    createJobBtn.disabled = true;
                } else {
                    freqRangeEl.style.color = 'var(--text-color-muted)';
                    createJobBtn.disabled = false;
                }
            } catch (error) {
                freqRangeEl.textContent = 'Error calculating range';
                createJobBtn.disabled = true;
            }
        }

        // --- Modal Functions ---

        /**
         * Opens the log modal and populates it with job data
         * @param {number} jobId
         */
        function showLogModal(jobId) {
            const job = jobsState.get(jobId);
            if (!job) return;

            logModalTitle.textContent = `Logs for Job ${jobId} (${job.settings.rec_type} @ ${formatFreqMHz(job.settings.frequency)} MHz)`;
            
            if (job.logs && job.logs.length > 0) {
                logModalBody.textContent = job.logs
                    .map(log => `[${formatTimestamp(log.timestamp)}] ${log.data}`)
                    .join('\n');
            } else {
                logModalBody.textContent = 'No log entries found for this job.';
            }

            logModal.style.display = 'block';
        }

        /** Closes the log modal */
        function closeLogModal() {
            logModal.style.display = 'none';
        }

        // --- API Functions ---

        /**
         * Checks the health of the API
         */
        async function checkApiStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const text = await response.text();
                apiStatusEl.textContent = `API Status: ${text}`;
                apiStatusEl.className = 'online';
            } catch (error) {
                console.error('API status check failed:', error);
                apiStatusEl.textContent = 'API Status: OFFLINE';
                apiStatusEl.className = 'offline';
            }
        }

        /**
         * Fetches all job statuses and re-renders the table
         */
        async function fetchAllJobs() {
            try {
                const response = await fetch(`${API_BASE_URL}/recorder/status`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                /** @type {JobStatus[]} */
                const jobs = await response.json();

                // Update state
                jobsState.clear();
                jobs.forEach(job => jobsState.set(job.job_id, job));
                
                // Render table
                renderJobsTable();

            } catch (error) {
                console.error('Failed to fetch jobs:', error);
                jobsTableBody.innerHTML = `<tr><td colspan="10" style="text-align:center; color: var(--accent-color);">Failed to load jobs.</td></tr>`;
            }
        }

        /**
         * Renders the jobs table from the `jobsState`
         */
        function renderJobsTable() {
            jobsTableBody.innerHTML = ''; // Clear existing table

            if (jobsState.size === 0) {
                jobsTableBody.innerHTML = `<tr><td colspan="10" style="text-align:center;">No active jobs found.</td></tr>`;
                return;
            }
            
            // Sort jobs by ID
            const sortedJobs = Array.from(jobsState.values()).sort((a, b) => a.job_id - b.job_id);

            for (const job of sortedJobs) {
                const tr = document.createElement('tr');
                tr.setAttribute('data-job-id', job.job_id);
                
                const statusText = job.running ? 'RUNNING' : 'STOPPED';
                const statusColor = job.running ? '#28a745' : 'var(--accent-color)';
                
                tr.innerHTML = `
                    <td>${job.job_id}</td>
                    <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
                    <td>${job.settings.rec_type.toUpperCase()}</td>
                    <td>${formatFreqMHz(job.settings.frequency)}</td>
                    <td>${job.settings.zoom ?? 'N/A'}</td>
                    <td>${job.settings.duration === 0 ? 'Infinite' : job.settings.duration}</td>
                    <td>${job.settings.interval ?? 'One-time'}</td>
                    <td>${formatTimestamp(job.started_at)}</td>
                    <td>${formatTimestamp(job.next_run_start)}</td>
                    <td>
                        <div class="button-group">
                            <button class="btn-stop" data-job-id="${job.job_id}" ${!job.running ? 'disabled' : ''}>Stop</button>
                            <button class="btn-logs" data-job-id="${job.job_id}">Logs</button>
                            <button class="btn-remove" data-job-id="${job.job_id}">Remove</button>
                        </div>
                    </td>
                `;
                jobsTableBody.appendChild(tr);
            }

            // Add event listeners to new buttons
            jobsTableBody.querySelectorAll('.btn-stop').forEach(btn => {
                btn.addEventListener('click', (e) => handleStopJob(e.currentTarget.dataset.jobId));
            });
            jobsTableBody.querySelectorAll('.btn-logs').forEach(btn => {
                btn.addEventListener('click', (e) => showLogModal(parseInt(e.currentTarget.dataset.jobId, 10)));
            });
            jobsTableBody.querySelectorAll('.btn-remove').forEach(btn => {
                btn.addEventListener('click', (e) => handleRemoveJob(e.currentTarget.dataset.jobId));
            });
        }

        /**
         * Handles the "Create Job" form submission
         * @param {Event} event
         */
        async function handleCreateJob(event) {
            event.preventDefault();
            createJobBtn.disabled = true;
            createJobBtn.textContent = 'Creating...';

            try {
                const intervalVal = parseInt(intervalInput.value, 10);
                
                /** @type {RecorderSettings} */
                const settings = {
                    rec_type: recTypeInput.value,
                    frequency: parseInt(frequencyInput.value, 10),
                    zoom: parseInt(zoomInput.value, 10),
                    duration: parseInt(durationInput.value, 10),
                    interval: isNaN(intervalVal) || intervalVal <= 0 ? null : intervalVal,
                };
                
                // IQ recordings don't use zoom
                if (settings.rec_type === 'iq') {
                    delete settings.zoom;
                }

                const response = await fetch(`${API_BASE_URL}/recorder/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                // const newJob = await response.json();
                // console.log('Job created:', newJob);
                
                // Reset form (optional)
                // createJobForm.reset(); 
                // updateFreqRangeDisplay();
                
                await fetchAllJobs(); // Refresh the list

            } catch (error) {
                console.error('Failed to create job:', error);
                // Use a more robust notification system later
                window.alert(`Error creating job: ${error.message}`);
            } finally {
                createJobBtn.disabled = false;
                createJobBtn.textContent = 'Start Job';
            }
        }
        
        /**
         * Handles stopping a job
         * @param {string} jobId
         */
        async function handleStopJob(jobId) {
            const btn = jobsTableBody.querySelector(`button.btn-stop[data-job-id="${jobId}"]`);
            if (btn) btn.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE_URL}/recorder/stop/${jobId}`, {
                    method: 'POST',
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                
                await fetchAllJobs(); // Refresh list to show updated status
            
            } catch (error) {
                console.error(`Failed to stop job ${jobId}:`, error);
                window.alert(`Error stopping job ${jobId}: ${error.message}`);
                if (btn) btn.disabled = false;
            }
        }

        /**
         * Handles removing a job
         * @param {string} jobId
         */
        async function handleRemoveJob(jobId) {
            // Optional: add a confirmation
            // if (!confirm(`Are you sure you want to permanently remove Job ${jobId}?`)) {
            //     return;
            // }

            const btn = jobsTableBody.querySelector(`button.btn-remove[data-job-id="${jobId}"]`);
            if (btn) btn.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/recorder/${jobId}`, {
                    method: 'DELETE',
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                
                // const result = await response.json();
                // console.log(result.message);

                await fetchAllJobs(); // Refresh list
            
            } catch (error) {
                console.error(`Failed to remove job ${jobId}:`, error);
                window.alert(`Error removing job ${jobId}: ${error.message}`);
                if (btn) btn.disabled = false;
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial setup
            checkApiStatus();
            fetchAllJobs();
            updateFreqRangeDisplay();

            // Set up auto-refresh
            setInterval(fetchAllJobs, REFRESH_INTERVAL_MS);

            // Form listeners
            createJobForm.addEventListener('submit', handleCreateJob);
            frequencyInput.addEventListener('input', updateFreqRangeDisplay);
            zoomInput.addEventListener('input', updateFreqRangeDisplay);

            // Manual refresh button
            refreshBtn.addEventListener('click', fetchAllJobs);
            
            // Modal listeners
            modalCloseBtn.addEventListener('click', closeLogModal);
            window.addEventListener('click', (event) => {
                if (event.target == logModal) {
                    closeLogModal();
                }
            });
        });

    </script>
</body>
</html>