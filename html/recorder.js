"use strict";const e="https://kiwisdr.local/api",t=3e7;let n=!1,o=!1;function a(){const e=document.getElementById("typeSelect").value,a=document.getElementById("zoomInput"),d=parseInt(a.value,10),i=1e3*parseFloat(document.getElementById("freqInput").value),l=document.getElementById("bandwidthLine"),c=document.getElementById("minFreqLine"),m=document.getElementById("maxFreqLine"),u=document.getElementById("zoomWarning"),g=document.getElementById("startBtn"),{bandwidth:y,selection_freq_min:_,selection_freq_max:p,zoom_invalid:h,error_messages:f}=function(e,n,o){let a=0,d=0,i=0,l=!1,c=[];const{nr_valid:m,nr_error_messages:u}=r(e,"Frequency");if(c.push(...u),!m)return{bandwidth:0,selection_freq_min:0,selection_freq_max:0,freq_range_invalid:null,zoom_invalid:!1,error_messages:c};if("png"==o){const{zoom_valid:e,zoom_error_messages:t}=function(e){let t=!0,n=[];const{nr_valid:o,nr_error_messages:a}=r(e,"Zoom");return n.push(...a),o?e<0?(n.push(`Zoom is too low: ${e}. Minimum is 0.`),t=!1):e>14&&(n.push(`Zoom is too high: ${e}. Maximum is 14.`),t=!1):t=!1,{zoom_valid:t,zoom_error_messages:n}}(n);if(c.push(...t),!e)return{bandwidth:0,selection_freq_min:0,selection_freq_max:0,freq_range_invalid:null,zoom_invalid:!0,error_messages:c};a=3e7/Math.pow(2,n)}else{if("iq"!=o)return c.push(`Invalid type: ${o}`),{bandwidth:0,selection_freq_min:0,selection_freq_max:0,freq_range_invalid:null,zoom_invalid:!1,error_messages:c};a=12e3}return i=e+a/2,d=e-a/2,i>t&&(c.push("Frequency range exceeds MAX_FREQ "+s(t)+". Selected max = "+s(i)),l=!0),d<0&&(c.push("Frequency range below MIN_FREQ "+s(0)+". Selected min = "+s(d)),l=!0),{bandwidth:a,selection_freq_min:d,selection_freq_max:i,freq_range_invalid:l,zoom_invalid:!1,error_messages:c}}(i,d,e);f.length>0?(u.style.display="block",u.innerHTML=f.join("<br><br>"),o=!0,g.disabled=n||o):(u.style.display="none",o=!1,g.disabled=n||o),h?(l.textContent="Bandwidth: --",c.textContent="Min: --",m.textContent="Max: --"):(l.textContent="Bandwidth: "+s(y),c.textContent="Min: "+s(_),m.textContent="Max: "+s(p))}function r(e,t){let n=!0,o=[];return isNaN(e)&&(o.push(t+" is not a number."),n=!1),{nr_valid:n,nr_error_messages:o}}function s(e){return Math.abs(e)<1e3?`${e.toFixed(0)} Hz`:Math.abs(e)>=1e3&&Math.abs(e)<1e6?`${(e/1e3).toFixed(1)} kHz`:`${(e/1e6).toFixed(1)} MHz`}async function d(){try{const t=await fetch(`${e}/recorder/status`),a=await t.json(),r=document.getElementById("recorderStatus"),s=document.getElementById("startedAt"),d=document.getElementById("logsContainer"),i=document.getElementById("logTableBody");if(n=a.recording,document.getElementById("startBtn").disabled=n||o,document.getElementById("stopBtn").disabled=!n,a.recording?(r.textContent="Recording",r.style.color="var(--accent-color)"):(r.textContent="Not Recording",r.style.color="var(--text-color-muted)"),a.started_at){const e=new Date(1e3*a.started_at);s.textContent=`Started at: ${e.toLocaleString(void 0,{hour12:!1})}`}else s.textContent="Started at: --/--/--, --:--:--";if(a.last_logs&&a.last_logs.length>0){d.style.display="flex",i.innerHTML="";for(const e of a.last_logs){const t=document.createElement("tr"),n=document.createElement("td"),o=new Date(1e3*e.timestamp).toLocaleString(void 0,{hour12:!1});n.textContent=o,t.appendChild(n);const a=document.createElement("td");a.textContent=e.data,t.appendChild(a),i.appendChild(t)}}else d.style.display="none"}catch(e){console.error("Failed to fetch recorder status:",e)}}const i=document.getElementById("api-status");!async function(){try{const t=await fetch(`${e}/`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const n=await t.text();i.textContent=`API Status: ${n}`,i.className="online"}catch(e){console.error("API status check failed:",e),i.textContent="API Status: OFFLINE",i.className="offline"}}(),d(),setInterval(d,1e3),document.getElementById("freqInput").addEventListener("input",a),document.getElementById("zoomInput").addEventListener("input",a),document.getElementById("typeSelect").addEventListener("change",a),a(),window.startRecording=async function(){const t=document.getElementById("typeSelect").value,n=parseFloat(document.getElementById("freqInput").value),o=Math.round(1e3*n),a=parseInt(document.getElementById("zoomInput").value,10),r={rec_type:t,frequency:o,autostop:parseInt(document.getElementById("autostopInput").value,10)||0,zoom:a};try{const t=await fetch(`${e}/recorder/start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),n=await t.json();document.getElementById("messageBox").textContent=n.message,await d()}catch(e){document.getElementById("messageBox").textContent="Failed to start recorder."}},window.stopRecording=async function(){try{const t=await fetch(`${e}/recorder/stop`,{method:"POST"}),n=await t.json();document.getElementById("messageBox").textContent=n.message,await d()}catch(e){document.getElementById("messageBox").textContent="Failed to stop recorder."}},window.handleTypeChange=function(){const e=document.getElementById("typeSelect").value;document.getElementById("zoomInput").disabled="png"!==e};