"use strict";const e="https://kiwisdr.local/api",t=3e7,n=document.getElementById("api-status"),o=document.getElementById("create-job-form"),r=document.getElementById("create-job-btn"),a=(document.getElementById("jobs-table-body"),document.getElementById("freq-range")),s=document.getElementById("bandwith"),i=document.getElementById("warning"),d=document.getElementById("rec_type"),l=document.getElementById("frequency"),c=document.getElementById("zoom"),m=document.getElementById("duration"),u=document.getElementById("interval");let _=!1;function f(){const{bandwidth:e,selection_freq_min:n,selection_freq_max:o,zoom_invalid:m,error_messages:u}=function(e,n,o){let r=0,a=0,s=0,i=!1,d=[];const{nr_valid:l,nr_error_messages:c}=g(e,"Frequency");if(d.push(...c),!l)return{bandwidth:0,selection_freq_min:0,selection_freq_max:0,freq_range_invalid:null,zoom_invalid:!1,error_messages:d};if("png"==o){const{zoom_valid:e,zoom_error_messages:t}=function(e){let t=!0,n=[];const{nr_valid:o,nr_error_messages:r}=g(e,"Zoom");return n.push(...r),o?e<0?(n.push(`Zoom is too low: ${e}. Minimum is 0.`),t=!1):e>14&&(n.push(`Zoom is too high: ${e}. Maximum is 14.`),t=!1):t=!1,{zoom_valid:t,zoom_error_messages:n}}(n);if(d.push(...t),!e)return{bandwidth:0,selection_freq_min:0,selection_freq_max:0,freq_range_invalid:null,zoom_invalid:!0,error_messages:d};r=3e7/Math.pow(2,n)}else{if("iq"!=o)return d.push(`Invalid type: ${o}`),{bandwidth:0,selection_freq_min:0,selection_freq_max:0,freq_range_invalid:null,zoom_invalid:!1,error_messages:d};r=12e3}return s=e+r/2,a=e-r/2,s>t&&(d.push("Frequency range exceeds MAX_FREQ "+h(t)+". Selected max = "+h(s)),i=!0),a<0&&(d.push("Frequency range below MIN_FREQ "+h(0)+". Selected min = "+h(a)),i=!0),{bandwidth:r,selection_freq_min:a,selection_freq_max:s,freq_range_invalid:i,zoom_invalid:!1,error_messages:d}}(1e3*Number(l.value),Number(c.value),d.value);u.length>0?(i.textContent=u.join("<br><br>"),_=!0,r.disabled=_):(i.textContent="",_=!1,r.disabled=_),m?(a.textContent="Range: ---- Hz - ---- Hz",s.textContent="Bandwidth: ---- Hz"):(s.textContent="Bandwidth: "+h(e),a.textContent="Range: "+h(n)+" - "+h(o))}function g(e,t){let n=!0,o=[];return isNaN(e)&&(o.push(t+" is not a number."),n=!1),{nr_valid:n,nr_error_messages:o}}function h(e){return Math.abs(e)<1e3?`${e.toFixed(0)} Hz`:Math.abs(e)>=1e3&&Math.abs(e)<1e6?`${(e/1e3).toFixed(1)} kHz`:`${(e/1e6).toFixed(1)} MHz`}async function v(){try{const t=await fetch(`${e}/recorder/status`),n=await t.json();console.log(n)}catch(e){console.error("Failed to fetch recorder status:",e)}}async function y(t){t.preventDefault();const n={rec_type:d.value,frequency:Math.round(1e3*parseFloat(l.value)),zoom:parseInt(c.value,10),duration:parseInt(m.value,10),interval:parseInt(u.value,10)};try{const t=await fetch(`${e}/recorder/start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),o=await t.json();console.log(o),await v()}catch(e){i.textContent=`Failed to start recorder. Error: ${e}`}}document.addEventListener("DOMContentLoaded",()=>{!async function(){try{const t=await fetch(`${e}/`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const o=await t.text();n.textContent=`API Status: ${o}`,n.className="online"}catch(e){console.error("API status check failed:",e),n.textContent="API Status: OFFLINE",n.className="offline"}}(),v(),setInterval(v,5e3),l.addEventListener("input",f),c.addEventListener("change",f),o.addEventListener("submit",y),f()});