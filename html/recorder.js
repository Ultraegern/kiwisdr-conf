"use strict";const e="https://kiwisdr.local/api",t=3e7,n=document.getElementById("api-status"),o=document.getElementById("create-job-form"),r=document.getElementById("create-job-btn"),a=document.getElementById("jobs-table-body"),s=document.getElementById("freq-range"),i=document.getElementById("bandwidth"),d=document.getElementById("warning"),c=document.getElementById("rec_type"),l=document.getElementById("frequency"),u=document.getElementById("zoom"),m=document.getElementById("duration"),_=document.getElementById("interval");let g=!1;function b(){const{bandwidth:e,selection_freq_min:n,selection_freq_max:o,zoom_invalid:a,error_messages:m}=function(e,n,o){let r=0,a=0,s=0,i=!1,d=[];const{nr_valid:c,nr_error_messages:l}=f(e,"Frequency");if(d.push(...l),!c)return{bandwidth:0,selection_freq_min:0,selection_freq_max:0,freq_range_invalid:null,zoom_invalid:!1,error_messages:d};if("png"==o){const{zoom_valid:e,zoom_error_messages:t}=function(e){let t=!0,n=[];const{nr_valid:o,nr_error_messages:r}=f(e,"Zoom");return n.push(...r),o?e<0?(n.push(`Zoom is too low: ${e}. Minimum is 0.`),t=!1):e>14&&(n.push(`Zoom is too high: ${e}. Maximum is 14.`),t=!1):t=!1,{zoom_valid:t,zoom_error_messages:n}}(n);if(d.push(...t),!e)return{bandwidth:0,selection_freq_min:0,selection_freq_max:0,freq_range_invalid:null,zoom_invalid:!0,error_messages:d};r=3e7/Math.pow(2,n)}else{if("iq"!=o)return d.push(`Invalid type: ${o}`),{bandwidth:0,selection_freq_min:0,selection_freq_max:0,freq_range_invalid:null,zoom_invalid:!1,error_messages:d};r=12e3}return s=e+r/2,a=e-r/2,s>t&&(d.push("Frequency range exceeds MAX_FREQ "+v(t)+". Selected max = "+v(s)),i=!0),a<0&&(d.push("Frequency range below MIN_FREQ "+v(0)+". Selected min = "+v(a)),i=!0),{bandwidth:r,selection_freq_min:a,selection_freq_max:s,freq_range_invalid:i,zoom_invalid:!1,error_messages:d}}(1e3*Number(l.value),Number(u.value),c.value);m.length>0?(d.innerHTML=m.join("<br>"),g=!0,r.disabled=g):(d.innerHTML="",g=!1,r.disabled=g),a?(s.textContent="Range: ---- Hz - ---- Hz",i.textContent="Bandwidth: ---- Hz"):(i.textContent="Bandwidth: "+v(e),s.textContent="Range: "+v(n)+" - "+v(o))}function f(e,t){let n=!0,o=[];return isNaN(e)&&(o.push(t+" is not a number."),n=!1),{nr_valid:n,nr_error_messages:o}}function v(e){return Math.abs(e)<1e3?`${e.toFixed(0)} Hz`:Math.abs(e)>=1e3&&Math.abs(e)<1e6?`${(e/1e3).toFixed(1)} kHz`:`${(e/1e6).toFixed(1)} MHz`}function h(e){return null==e?"None":new Date(1e3*e).toLocaleString(void 0,{hour12:!1})}async function y(){try{const t=await fetch(`${e}/recorder/status`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);!async function(e){if(a.innerHTML="",0!=e.length)for(const t of e){const e=document.createElement("tr");e.setAttribute("data-job-id",`${t.job_id}`);const n=t.running?"Recording":"Stoped",o=t.running?"var(--green)":"var(--accent-color)";let r=`Type: ${t.settings.rec_type}<br>`;r+=`Freq: ${v(t.settings.frequency)}<br>`,r+=`Duration: ${t.settings.duration}s`,"png"===t.settings.rec_type&&(r+=`<br>Zoom: ${t.settings.zoom}`),t.settings.interval&&(r+=`<br>Interval: ${t.settings.interval}s`),e.innerHTML=`\n            <td>${t.job_id}</td>\n            <td style="color: ${o}; font-weight: bold;">${n}</td>\n            <td style="white-space: nowrap;">${r}</td>\n            <td>${h(t.started_at)}</td>\n            <td>${h(t.next_run_start)}</td>\n            <td>\n                <div class="button-group">\n                    <button class="btn-stop" data-job-id="${t.job_id}" ${t.running?"":"disabled"}>Stop</button>\n                    <button class="btn-logs" data-job-id="${t.job_id}">Logs</button>\n                    <button class="btn-remove" data-job-id="${t.job_id}">Remove</button>\n                </div>\n            </td>\n        `,a.appendChild(e)}else a.innerHTML='<tr><td colspan="10" style="text-align:center;">No active jobs found.</td></tr>'}(await t.json())}catch(e){console.error("Failed to fetch recorder status:",e)}}async function p(t){t.preventDefault();const n=c.value,o=Math.round(1e3*parseFloat(l.value)),r="png"===n?parseInt(u.value,10):void 0,a=parseInt(m.value,10),s=parseInt(_.value,10),i={rec_type:n,frequency:o,zoom:r,duration:a,interval:isNaN(s)?null:s};try{const t=await fetch(`${e}/recorder/start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),n=await t.json();console.log(n),await y()}catch(e){d.innerHTML=`Failed to start recorder. Error: ${e}`}}function $(t){const n=t.target.closest("button");if(n){const t=n.getAttribute("data-job-id");if(t){const o=parseInt(t,10);n.classList.contains("btn-remove")&&confirm(`Are you sure you want to remove Job ID ${o}?`)&&async function(t){try{const n=await fetch(`${e}/recorder/${t}`,{method:"DELETE"});if(!n.ok)throw new Error(`Failed to remove job: ${n.statusText}`);await y(),console.log(`Job ${t} removed successfully.`)}catch(e){console.error(`Error removing job ${t}:`,e),d.innerHTML=`Failed to remove job ${t}. Error: ${e}`}}(o)}}}document.addEventListener("DOMContentLoaded",()=>{!async function(){try{const t=await fetch(`${e}/`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const o=await t.text();n.textContent=`API Status: ${o}`,n.className="online"}catch(e){console.error("API status check failed:",e),n.textContent="API Status: OFFLINE",n.className="offline"}}(),y(),setInterval(y,5e3),l.addEventListener("input",b),u.addEventListener("change",b),c.addEventListener("change",b),o.addEventListener("submit",p),a.addEventListener("click",$),b()});