<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KiwiFiles</title>
  <link rel="stylesheet" href="/stylesheet.css">
</head>
<body>
	<div class="background"></div>
	<h1>KiwiFiles</h1>
	<p>Browse and download your recordings below:</p>

	<div class="table-container">
		<table id="file-table">
			<thead>
				<tr>
					<th>Filename</th>
					<th>Date & Time (UTC)</th>
					<th>Size</th>
					<th>Download</th>
				</tr>
			</thead>
			<tbody>
			<!-- JS will inject rows here -->
			</tbody>
		</table>
		</div>

	<script>
		const DOWNLOAD_URL = '/recorder/download/';

		async function fetchFileList() {
		try {
			const res = await fetch(DOWNLOAD_URL);
			const text = await res.text();
			const doc = new DOMParser().parseFromString(text, 'text/html');

			const pre = doc.querySelector('pre');
			if (!pre) {
				document.getElementById('file-table').innerHTML = "<tr><td colspan='4'>No files found.</td></tr>";
				return;
			}

			const lines = pre.innerText.split('\n').slice(3); // Skip header lines

			const files = [];

			lines.forEach(line => {
			// Match lines like: file123.wav  15-Oct-2025 13:50  100M
			const match = line.match(/(\S+)\s+(\d{2})-(\w{3})-(\d{4})\s+(\d{2}):(\d{2})\s+([\d.]+\w?)/);
			if (!match) return;

			const [_, name, day, monthStr, year, hour, minute, size] = match;

			const monthMap = {
				Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5,
				Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11
			};

			const month = monthMap[monthStr];
			const fileDate = new Date(year, month, day, hour, minute);

			files.push({ name, size, date: fileDate });
			});

			// Sort by date descending (newest first)
			files.sort((a, b) => b.date - a.date);

			// Populate the table
			const tbody = document.querySelector('#file-table tbody');
			files.forEach(file => {
			const tr = document.createElement('tr');
			const pad = n => n.toString().padStart(2, '0');
			const d = file.date;
			const formattedDate = `${pad(d.getHours())}:${pad(d.getMinutes())} ${pad(d.getDate())}/${pad(d.getMonth() + 1)}-${d.getFullYear()}`;

			tr.innerHTML = `
				<td>${file.name}</td>
				<td>${formattedDate}</td>
				<td>${file.size}B</td>
				<td><a href="${DOWNLOAD_URL + encodeURIComponent(file.name)}" target="_blank"><button>Download</button></a></td>
			`;

			tbody.appendChild(tr);
			});

		} catch (err) {
			console.error('Error loading file list:', err);
			document.querySelector('#file-table tbody').innerHTML = `<tr><td colspan="4">Error: ${err.message}</td></tr>`;
		}
		}

		fetchFileList();
		</script>
</body>
</html>