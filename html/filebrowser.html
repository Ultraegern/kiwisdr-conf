<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SDR Recordings Browser</title>
  <link rel="stylesheet" href="/stylesheet.css">
</head>
<body>
	<div class="background"></div>
	<h1>KiwiFiles</h1>
	<p>Browse and download your recordings below:</p>

	<div class="table-container">
		<table id="file-table">
			<thead>
				<tr>
					<th>Filename</th>
					<th>Date & Time</th>
					<th>Size</th>
					<th>Download</th>
				</tr>
			</thead>
			<tbody>
			<!-- JS will inject rows here -->
			</tbody>
		</table>
		</div>

	<script>
		const DOWNLOAD_URL = '/recorder/download/';

		async function fetchFileList() {
		try {
			const res = await fetch(DOWNLOAD_URL);
			const text = await res.text();
			const doc = new DOMParser().parseFromString(text, 'text/html');

			const pre = doc.querySelector('pre');
			if (!pre) {
				document.getElementById('file-table').innerHTML = "<tr><td colspan='4'>No files found.</td></tr>";
				return;
			}

			const lines = pre.innerText.split('\n').slice(3); // Skip header rows

			const tbody = document.querySelector('#file-table tbody');
			lines.forEach(line => {
			// Match line with filename, date, time, size (from NGINX autoindex format)
			const match = line.match(/(\S+)\s+(\d{2}-\w{3}-\d{4})\s+(\d{2}:\d{2})\s+([\d.]+\w?)/);
			if (!match) return;

			const [_, name, date, time, size] = match;
			const tr = document.createElement('tr');

			tr.innerHTML = `
				<td>${name}</td>
				<td>${date.replace(/-/g, '/') + ' ' + time}</td>
				<td>${size}</td>
				<td><a href="${DOWNLOAD_URL + encodeURIComponent(name)}" target="_blank"><button>Download</button></a></td>
			`;

			tbody.appendChild(tr);
			});

		} catch (err) {
			console.error('Error loading file list:', err);
			document.querySelector('#file-table tbody').innerHTML = `<tr><td colspan="4">Error: ${err.message}</td></tr>`;
		}
		}

		fetchFileList();
	</script>
</body>
</html>