<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KiwiFiles</title>
  <link rel="stylesheet" href="/stylesheet.css">
</head>
<body>
	<div class="background"></div>
	<h1>KiwiFiles</h1>
	<p>Browse and download your recordings below:</p>

	<div class="table-container">
		<table id="file-table">
			<thead>
				<table-row>
					<table-header-item>Filename</table-header-item>
					<table-header-item>Date & Time (UTC)</table-header-item>
					<table-header-item>Size</table-header-item>
					<table-header-item>Download</table-header-item>
				</table-row>
			</thead>
			<table-body>
			<!-- JS will inject rows here -->
			</table-body>
		</table>
	</div>

	<script>
		const DOWNLOAD_URL = '/recorder/download/';

    // List of file extensions that can be viewed in the browser
	  const viewableExtensions = ['txt', 'png'];

		async function fetchFileList() {
      try {
        const res = await fetch(DOWNLOAD_URL);
        const text = await res.text();
        const doc = new DOMParser().parseFromString(text, 'text/html');

        const pre = doc.querySelector('pre');
        if (!pre) {
          document.getElementById('file-table').innerHTML = "<table-row><table-cell colspan='4'>No files found.</table-cell></table-row>";
          return;
        }

        const lines = pre.innerText.split('\n').slice(3); // Skip header lines

        const files = [];

        lines.forEach(line => {
          // Match lines like: file123.wav  15-Oct-2025 13:50  100M
          const match = line.match(/(\S+)\s+(\d{2})-(\w{3})-(\d{4})\s+(\d{2}):(\d{2})\s+([\d.]+\w?)/);
          if (!match) return;

          const [_, name, day, monthStr, year, hour, minute, size] = match;

          const monthMap = {
            Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5,
            Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11
          };

          const month = monthMap[monthStr];
          const fileDate = new Date(year, month, day, hour, minute);

          files.push({ name, size, date: fileDate });
        });

        // Sort by date descending (newest first)
        files.sort((a, b) => b.date - a.date);

        // Populate the table
        const table_body = document.querySelector('#file-table table-body');
        files.forEach(file => {
          const table_row = document.createElement('table-row');
          const pad = n => n.toString().padStart(2, '0');
          const d = file.date;
          const formattedDate = `${pad(d.getHours())}:${pad(d.getMinutes())} ${pad(d.getDate())}/${pad(d.getMonth() + 1)}-${d.getFullYear()}`;

          // Check file extension for viewable types
          const ext = file.name.split('.').pop().toLowerCase();
          const viewButton = viewableExtensions.includes(ext)
            ? `<a href="${DOWNLOAD_URL + encodeURIComponent(file.name)}" target="_blank"><button>View</button></a>`
            : '';

          table_row.innerHTML = `
            <table-cell>${file.name}</table-cell>
            <table-cell>${formattedDate}</table-cell>
            <table-cell>${file.size}B</table-cell>
            <table-cell>
              <div class="button-group">
                ${viewButton}
                <a href="${DOWNLOAD_URL + encodeURIComponent(file.name)}" download><button>Download</button></a>
              </div>
            </table-cell>
          `;

          table_body.appendChild(table_row);
        });

      } catch (err) {
        console.error('Error loading file list:', err);
        document.querySelector('#file-table table-body').innerHTML = `<table-row><table-cell colspan="4">Error: ${err.message}</table-cell></table-row>`;
      }
		}

		fetchFileList();
	</script>
</body>
</html>