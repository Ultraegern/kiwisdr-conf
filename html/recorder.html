<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KiwiRecorder</title>
  <link rel="stylesheet" href="stylesheet.css">
</head>
<body>
  <div class="background"></div>
  <div class="center">
    <h1>KiwiRecorder</h1>
    <p>Control and monitor your KiwiSDR recordings.</p>

    <div class="field-group">
      <div class="field">
        <label for="typeSelect">Type:</label>
        <select id="typeSelect" onchange="handleTypeChange()">
          <option value="png">PNG</option>
          <option value="iq">IQ</option>
        </select>
      </div>

      <div class="field">
        <label for="autostopInput">Auto-stop (sec, 0 = off):</label>
        <input id="autostopInput" type="number" min="0" max="65535" step="1" value="0">
      </div>

      <div class="field">
        <label for="freqInput">Center Frequency (kHz):</label>
        <input id="freqInput" type="number" min="0" max="30000" step="0.001" value="20">
      </div>

      <div class="field" id="zoomField">
        <label for="zoomInput">Zoom:</label>
        <input id="zoomInput" type="number" min="0" max="14" step="1" value="11">
      </div>

      <div class="field">
        <div id="bandwidthInfo">
          <div id="bandwidthLine">Bandwidth: --</div>
          <div id="minFreqLine">Min: --</div>
          <div id="maxFreqLine">Max: --</div>
          <div id="zoomWarning" style="color: var(--accent-color); font-weight: bold; display:none;">Invalid zoom! Max = 14</div>
        </div>
      </div>

      <div>
        <button id="startBtn" onclick="startRecording()">Start Recording</button>
        <button id="stopBtn" onclick="stopRecording()">Stop Recording</button>
      </div>
    </div>

    <div id="messageBox" style="margin-top: 20px; font-weight: bold; color: var(--text-color-muted);"></div>

    <div id="statusBox" style="margin-top: 20px;">
      <h2 style="color: var(--text-color)">Status: <span style="color: var(--accent-color)" id="recorderStatus">Loading...</span></h2>
      <p id="startedAt"></p>
    </div>

    <div class="table-container" id="logsContainer" style="display:none;">
      <table>
        <thead>
          <tr><th>Recent Logs</th></tr>
        </thead>
        <tbody id="logTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_BASE = "/api";
    const MIN_FREQ = 0;
    const MAX_FREQ = 30_000_000;
    const MAX_ZOOM = 14;

    function updateBandwidthInfo() {
      const type = document.getElementById('typeSelect').value;
      const zoomInput = document.getElementById('zoomInput');
      const freqInput = parseFloat(document.getElementById('freqInput').value) * 1000; // kHz → Hz

      
      const bandwidthLine = document.getElementById('bandwidthLine');
      const minFreqLine = document.getElementById('minFreqLine');
      const maxFreqLine = document.getElementById('maxFreqLine');
      const zoomWarning = document.getElementById('zoomWarning');

      // Disable field if type is not PNG
      const isPNG = (type === 'png');

      let messages = [];
      let zoomInvalidNr = false;

      const zoom = parseInt(zoomInput.value, 10);
      if (isNaN(zoom)) {
        messages.push("Zoom is not a number.");
        zoomInvalidNr = true;
      } else {
        if (zoom < 0) {
          messages.push(`Zoom is too low: ${zoom}. Minimum is 0.`);
          zoomInvalidNr = true;
        }
        if (zoom > MAX_ZOOM) {
          messages.push(`Zoom is too high: ${zoom}. Maximum is ${MAX_ZOOM}.`);
          zoomInvalidNr = true;
        }
      }

      let frequencyRangeInvalid = false

      let bandwidth = 0, selection_freq_min = 0, selection_freq_max = 0;
      if (!zoomInvalidNr) {
        bandwidth = (MAX_FREQ - MIN_FREQ) / Math.pow(2, zoom);
        selection_freq_max = freqInput + bandwidth / 2;
        selection_freq_min = freqInput - bandwidth / 2;
        if (selection_freq_max > MAX_FREQ) {
          messages.push("Frequency range exceeds MAX_FREQ " + format_freq(MAX_FREQ)+ ". Selected max = " + format_freq(selection_freq_max));
          frequencyRangeInvalid = true;
        }
        if (selection_freq_min < MIN_FREQ) {
          messages.push("Frequency range below MIN_FREQ " + format_freq(MIN_FREQ) + ". Selected min = " + format_freq(selection_freq_min));
          frequencyRangeInvalid = true;
        }
      }

      // Show or hide zoom warning
      if (frequencyRangeInvalid || zoomInvalidNr) {
        zoomWarning.style.display = 'block';
        zoomWarning.innerHTML = messages.join('<br>');
        return;
      } else {
        zoomWarning.style.display = 'none';
      }

      // Disable start button if there are errors
      if (zoomInvalidNr || frequencyRangeInvalid) {
        startBtn.disabled = true
      }
      else {
        startBtn.disabled = false
      }


      // If type not PNG, disable bandwidth display
      if (isPNG && !zoomInvalidNr) {
        bandwidthLine.textContent = "Bandwidth: " + format_freq(bandwidth);
        minFreqLine.textContent = "Min: " + format_freq(selection_freq_min);
        maxFreqLine.textContent = "Max: " + format_freq(selection_freq_max);
        
      }
      else {
        bandwidthLine.textContent = 'Bandwidth: --';
        minFreqLine.textContent = 'Min: --';
        maxFreqLine.textContent = 'Max: --';
      }
     }

    function handleTypeChange() {
      const type = document.getElementById('typeSelect').value;
      const zoomField = document.getElementById('zoomField');
      const bandwidthInfo = document.getElementById('bandwidthInfo');
      zoomInput.disabled = (type !== 'png');
      bandwidthInfo.disabled = (type !== "png")
    }

    function format_freq(freq_hz) { // Int -> Str
      switch (true) {
        case Math.abs(freq_hz) < 1000:
          return `${freq_hz} Hz`
        case Math.abs(freq_hz) >= 1000 && freq_hz < 1_000_000:
          let freq_khz = (freq_hz / 1000).toFixed(1)
          return `${freq_khz} kHz`
        case Math.abs(freq_hz) >= 1_000_000:
          let freq_mhz = (freq_hz / 1_000_000).toFixed(1)
          return `${freq_mhz} MHz`
      }
    }

    async function getRecorderStatus() {
      try {
        const response = await fetch(`${API_BASE}/recorder/status`);
        const data = await response.json();

        const statusEl = document.getElementById('recorderStatus');
        const startedAtEl = document.getElementById('startedAt');
        const logsContainer = document.getElementById('logsContainer');
        const logTableBody = document.getElementById('logTableBody');

        if (data.recording) {
          statusEl.textContent = "Recording";
          statusEl.style.color = "var(--accent-color)";
          document.getElementById('startBtn').disabled = true;
          document.getElementById('stopBtn').disabled = false;
        } else {
          statusEl.textContent = "Not Recording";
          statusEl.style.color = "var(--text-color-muted)";
          document.getElementById('startBtn').disabled = false;
          document.getElementById('stopBtn').disabled = true;
        }

        if (data.started_at) {
          const date = new Date(data.started_at * 1000);
          startedAtEl.textContent = `Started at: ${date.toLocaleString(undefined, { hour12: false })}`;
        } else {
          startedAtEl.textContent = "Started at: --/--/--, --:--:--";
        }

        if (data.last_logs && data.last_logs.length > 0) {
          logsContainer.style.display = "flex";
          logTableBody.innerHTML = "";
          for (const log of data.last_logs) {
            const row = document.createElement("tr");
            const cell = document.createElement("td");
            cell.textContent = log;
            row.appendChild(cell);
            logTableBody.appendChild(row);
          }
        } else {
          logsContainer.style.display = "none";
        }
      } catch (err) {
        console.error("Failed to fetch recorder status:", err);
      }
    }

    async function startRecording() {
      const rec_type = document.getElementById('typeSelect').value;
      const freq_khz = parseFloat(document.getElementById('freqInput').value);
      const freq_hz = Math.round(freq_khz * 1000); // kHz → Hz
      const zoom = parseInt(document.getElementById('zoomInput').value, 10);
      const autostop = parseInt(document.getElementById('autostopInput').value, 10) || 0;

      const body = { rec_type, frequency: freq_hz, autostop };
      if (rec_type === 'png') body.zoom = zoom;

      try {
        const response = await fetch(`${API_BASE}/recorder/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await response.json();
        document.getElementById('messageBox').textContent = data.message;
        await getRecorderStatus();
      } catch (err) {
        document.getElementById('messageBox').textContent = "Failed to start recorder.";
      }
    }

    async function stopRecording() {
      try {
        const response = await fetch(`${API_BASE}/recorder/stop`, { method: 'POST' });
        const data = await response.json();
        document.getElementById('messageBox').textContent = data.message;
        await getRecorderStatus();
      } catch (err) {
        document.getElementById('messageBox').textContent = "Failed to stop recorder.";
      }
    }

    getRecorderStatus();
    setInterval(getRecorderStatus, 1000);

    // Update bandwidth info when freq or zoom changes
    document.getElementById('freqInput').addEventListener('input', updateBandwidthInfo);
    document.getElementById('zoomInput').addEventListener('input', updateBandwidthInfo);
    document.getElementById('typeSelect').addEventListener('change', updateBandwidthInfo);
    updateBandwidthInfo();
  </script>
</body>
</html>
