<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KiwiRecorder</title>
  <link rel="stylesheet" href="stylesheet.css">
</head>
<body>
  <div class="background"></div>
  <div class="center">
    <h1>KiwiRecorder</h1>
    <p>Control and monitor your KiwiSDR recordings.</p>

    <div class="field-group">
      <div class="field">
        <label for="typeSelect">Type:</label>
        <select id="typeSelect" onchange="handleTypeChange()">
          <option value="png">PNG</option>
          <option value="iq">IQ</option>
        </select>
      </div>

      <div class="field">
        <label for="autostopInput">Auto-stop (sec, 0 = off):</label>
        <input id="autostopInput" type="number" min="0" max="65535" step="1" value="0">
      </div>

      <div class="field">
        <label for="freqInput">Center Frequency (kHz):</label>
        <input id="freqInput" type="number" min="0" max="30000" step="0.001" value="20">
      </div>

      <div class="field" id="zoomField">
        <label for="zoomInput">Zoom:</label>
        <input id="zoomInput" type="number" min="0" max="14" step="1" value="11">
      </div>

      <div class="field">
        <div id="bandwidthInfo">
          <div id="bandwidthLine">Bandwidth: --</div>
          <div id="minFreqLine">Min: --</div>
          <div id="maxFreqLine">Max: --</div>
          <div id="zoomWarning" style="color: var(--accent-color); font-weight: bold; display:none;">Invalid zoom! Max = 14</div>
        </div>
      </div>

      <div>
        <button id="startBtn" onclick="startRecording()">Start Recording</button>
        <button id="stopBtn" onclick="stopRecording()">Stop Recording</button>
      </div>
    </div>

    <div id="messageBox" style="margin-top: 20px; font-weight: bold; color: var(--text-color-muted);"></div>

    <div id="statusBox" style="margin-top: 20px;">
      <h2 style="color: var(--text-color)">Status: <span style="color: var(--accent-color)" id="recorderStatus">Loading...</span></h2>
      <p id="startedAt"></p>
    </div>

    <div class="table-container" id="logsContainer" style="display:none;">
      <table>
        <thead>
          <table-row><table-header-item>Recent Logs</table-header-item></table-row>
        </thead>
        <table-body id="logTableBody"></table-body>
      </table>
    </div>
  </div>

  <script>
    const API_BASE = "/api";
    const MIN_FREQ = 0;
    const MAX_FREQ = 30_000_000;
    const MAX_ZOOM = 14;

    function updateBandwidthInfo() {
      const type = document.getElementById('typeSelect').value;
      const zoomInput = document.getElementById('zoomInput');
      const freqInput = parseFloat(document.getElementById('freqInput').value) * 1000; // kHz → Hz

      const bandwidthField = document.getElementById('bandwidthField');
      const bandwidthLine = document.getElementById('bandwidthLine');
      const minFreqLine = document.getElementById('minFreqLine');
      const maxFreqLine = document.getElementById('maxFreqLine');
      const zoomWarning = document.getElementById('zoomWarning');

      // Disable field if type is not PNG
      const isPNG = (type === 'png');
      bandwidthField.disabled = !isPNG;

      let messages = [];
      let zoomInvalid = false;

      const zoom = parseInt(zoomInput.value, 10);
      if (isNaN(zoom)) {
        messages.push("Zoom is not a number.");
        zoomInvalid = true;
      } else {
        if (zoom < 0) {
          messages.push(`Zoom is too low: ${zoom}. Minimum is 0.`);
          zoomInvalid = true;
        }
        if (zoom > MAX_ZOOM) {
          messages.push(`Zoom is too high: ${zoom}. Maximum is ${MAX_ZOOM}.`);
          zoomInvalid = true;
        }
      }

      let bandwidth = 0, selection_freq_min = 0, selection_freq_max = 0;
      if (!zoomInvalid) {
        bandwidth = (MAX_FREQ - MIN_FREQ) / Math.pow(2, zoom);
        selection_freq_max = freqInput + bandwidth / 2;
        selection_freq_min = freqInput - bandwidth / 2;

        if (selection_freq_max > MAX_FREQ) {
          messages.push(`Frequency range exceeds MAX_FREQ (${MAX_FREQ/1000} kHz). Selected max = ${(selection_freq_max/1000).toFixed(3)} kHz.`);
          zoomInvalid = true;
        }
        if (selection_freq_min < MIN_FREQ) {
          messages.push(`Frequency range below MIN_FREQ (${MIN_FREQ/1000} kHz). Selected min = ${(selection_freq_min/1000).toFixed(3)} kHz.`);
          zoomInvalid = true;
        }
      }

      // Show or hide zoom warning
      if (zoomInvalid) {
        zoomWarning.style.display = 'block';
        zoomWarning.innerHTML = messages.join('<br>');
        bandwidthLine.textContent = 'Bandwidth: --';
        minFreqLine.textContent = 'Min: --';
        maxFreqLine.textContent = 'Max: --';
        return;
      } else {
        zoomWarning.style.display = 'none';
      }

      // Disable start button if there are errors
      startBtn.disabled = zoomInvalid;


      // If type not PNG, disable bandwidth display
      if (!isPNG) {
        bandwidthLine.textContent = 'Bandwidth: --';
        minFreqLine.textContent = 'Min: --';
        maxFreqLine.textContent = 'Max: --';
        return;
      }

      bandwidth /= 1000;
      selection_freq_max /= 1000;
      selection_freq_min /= 1000;

      bandwidthLine.textContent = `Bandwidth: ${bandwidth.toFixed(3)} kHz`;
      minFreqLine.textContent = `Min: ${selection_freq_min.toFixed(3)} kHz`;
      maxFreqLine.textContent = `Max: ${selection_freq_max.toFixed(3)} kHz`;
    }

    function handleTypeChange() {
      const type = document.getElementById('typeSelect').value;
      const zoomField = document.getElementById('zoomField');
      zoomInput.disabled = (type !== 'png');
    }

    async function getRecorderStatus() {
      try {
        const response = await fetch(`${API_BASE}/recorder/status`);
        const data = await response.json();

        const statusEl = document.getElementById('recorderStatus');
        const startedAtEl = document.getElementById('startedAt');
        const logsContainer = document.getElementById('logsContainer');
        const logTableBody = document.getElementById('logTableBody');

        if (data.recording) {
          statusEl.textContent = "Recording";
          statusEl.style.color = "var(--accent-color)";
          document.getElementById('startBtn').disabled = true;
          document.getElementById('stopBtn').disabled = false;
        } else {
          statusEl.textContent = "Not Recording";
          statusEl.style.color = "var(--text-color-muted)";
          document.getElementById('startBtn').disabled = false;
          document.getElementById('stopBtn').disabled = true;
        }

        if (data.started_at) {
          const date = new Date(data.started_at * 1000);
          startedAtEl.textContent = `Started at: ${date.toLocaleString(undefined, { hour12: false })}`;
        } else {
          startedAtEl.textContent = "Started at: --/--/--, --:--:--";
        }

        if (data.last_logs && data.last_logs.length > 0) {
          logsContainer.style.display = "flex";
          logTableBody.innerHTML = "";
          for (const log of data.last_logs) {
            const row = document.createElement("table-row");
            const cell = document.createElement("table-cell");
            cell.textContent = log;
            row.appendChild(cell);
            logTableBody.appendChild(row);
          }
        } else {
          logsContainer.style.display = "none";
        }
      } catch (err) {
        console.error("Failed to fetch recorder status:", err);
      }
    }

    async function startRecording() {
      const rec_type = document.getElementById('typeSelect').value;
      const freq_khz = parseFloat(document.getElementById('freqInput').value);
      const freq_hz = Math.round(freq_khz * 1000); // kHz → Hz
      const zoom = parseInt(document.getElementById('zoomInput').value, 10);
      const autostop = parseInt(document.getElementById('autostopInput').value, 10) || 0;

      const body = { rec_type, frequency: freq_hz, autostop };
      if (rec_type === 'png') body.zoom = zoom;

      try {
        const response = await fetch(`${API_BASE}/recorder/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await response.json();
        document.getElementById('messageBox').textContent = data.message;
        await getRecorderStatus();
      } catch (err) {
        document.getElementById('messageBox').textContent = "Failed to start recorder.";
      }
    }

    async function stopRecording() {
      try {
        const response = await fetch(`${API_BASE}/recorder/stop`, { method: 'POST' });
        const data = await response.json();
        document.getElementById('messageBox').textContent = data.message;
        await getRecorderStatus();
      } catch (err) {
        document.getElementById('messageBox').textContent = "Failed to stop recorder.";
      }
    }

    getRecorderStatus();
    setInterval(getRecorderStatus, 1000);

    // Update bandwidth info when freq or zoom changes
    document.getElementById('freqInput').addEventListener('input', updateBandwidthInfo);
    document.getElementById('zoomInput').addEventListener('input', updateBandwidthInfo);
    document.getElementById('typeSelect').addEventListener('change', updateBandwidthInfo);
    updateBandwidthInfo();
  </script>
</body>
</html>
